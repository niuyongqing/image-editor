# Active Context & Development State

> **Version**: 2.3 (Object-Driven Navigation & Routing)
> **Last Updated**: 2025-12-23
> **Current Focus**: Global Navigation Architecture & Event-Driven UI, Fix Ruler Navigation

## 1. å½“å‰å¼€å‘çŠ¶æ€ (Current Status)

### âœ… å·²å®Œæˆæ¨¡å— (Completed Modules)

#### 1.1 æ ¸å¿ƒç¼–è¾‘ (Core Editing)

- **å‰ªè£ (Crop)**:
  - [x] **æ‰‹åŠ¨é€‰åŒº**: å®ç°äº† `startManualSelection`ï¼Œæ”¯æŒè‡ªå®šä¹‰æ¡†é€‰åŒºåŸŸã€‚
  - [x] **æ¯”ä¾‹é”å®š**: æ”¯æŒåŸå›¾æ¯”ä¾‹ã€è‡ªç”±æ¯”ä¾‹åŠå¸¸ç”¨é¢„è®¾ (1:1, 16:9 ç­‰)ã€‚
  - [x] **æ—‹è½¬ç¿»è½¬**: 90Â° æ­¥è¿›æ—‹è½¬ä¸ XY è½´ç¿»è½¬ã€‚
- **å°ºå¯¸è°ƒæ•´ (Resize)**:
  - [x] **é«˜æ¸…é‡åˆ¶**: å¼•å…¥ `useOffscreenHelper`ï¼Œå®ç°äº†åŸºäºåŸå›¾åˆ†è¾¨ç‡çš„é«˜æ¸…ç¼©æ”¾ã€‚
  - [x] **ä¿çœŸæ¨¡å¼**: æ”¯æŒé”å®šé•¿å®½æ¯”è®¡ç®—ã€‚
- **è¡¥ç™½ (White/Padding)**:
  - [x] **ç¤¾åª’é¢„è®¾**: é›†æˆ Instagram/Youtube ç­‰å¸¸ç”¨å°ºå¯¸æ¨¡æ¿ã€‚
  - [x] **æ™ºèƒ½å¸è‰²**: æ”¯æŒèƒŒæ™¯è‰²å¸å–åŠé€æ˜èƒŒæ™¯è®¾ç½®ã€‚

#### 1.2 æ‹¼å›¾ç³»ç»Ÿ (Puzzle System)

- **ç½‘æ ¼å¸ƒå±€**:
  - [x] **åŠ¨æ€æ¨¡æ¿**: åŸºäº `config.js` å®ç°äº† 1-16 å¼ å›¾ç‰‡çš„ç½‘æ ¼å¸ƒå±€è§£æã€‚
  - [x] **è‡ªåŠ¨å¸ƒå±€**: å›¾ç‰‡æ‹–å…¥è‡ªåŠ¨è®¡ç®— Cover è£å‰ªï¼Œä¿è¯å¡«æ»¡æ ¼å­ä¸ç•™ç™½ã€‚
- **äº¤äº’é€»è¾‘**:
  - [x] **æ‹–æ‹½äº¤æ¢**: å®ç°äº†å¹³æ»‘çš„äº¤æ¢åŠ¨ç”» (`animateSwap`) å’Œå¤±è´¥å›å¼¹ã€‚
  - [x] **ç‰©ç†çº¦æŸ**: åº”ç”¨ `useConstraint` é˜²æ­¢å›¾ç‰‡è„±ç¦»æ ¼å­å¯è§†åŒºã€‚
- **æ ·å¼è°ƒæ•´**:
  - [x] **å…¨å±€å‚æ•°**: æ”¯æŒåŠ¨æ€è°ƒæ•´é—´è·ã€è¾¹è·å’Œåœ†è§’ã€‚

#### 1.3 æ™ºèƒ½ä¸ç‰¹æ•ˆ (AI & Effects)

- **æ™ºèƒ½æ¶ˆé™¤ (Inpaint)**:
  - [x] **ç¦»å±é®ç½©**: è§£å†³é—ªçƒé—®é¢˜ï¼Œé€šè¿‡ç¦»å± Canvas ç”Ÿæˆ Maskã€‚
  - [x] **åŒæ¨¡äº¤äº’**: æ”¯æŒç”»ç¬” (Brush) å’Œ çŸ©å½¢æ¡†é€‰ (Rect)ã€‚
- **ä¸€é”®æŠ å›¾ (Rembg)**:
  - [x] **API é›†æˆ**: å°è£… `src/api/ai.js` æ”¯æŒä¸€é”®ç§»é™¤èƒŒæ™¯ã€‚
- **é©¬èµ›å…‹ (Mosaic)**:
  - [x] **æ— æŸå¤„ç†**: é‡‡ç”¨â€œé¢„è§ˆå±‚ + ç¦»å±åº”ç”¨â€ç­–ç•¥ã€‚
- **æ»¤é•œä¸è°ƒè‰²**:
  - [x] **ColorMatrix**: å®ç°äº®åº¦ã€å¯¹æ¯”åº¦ç­‰ 6 ç»´è°ƒèŠ‚ã€‚
  - [x] **LUT æ¨¡æ‹Ÿ**: å†…ç½®â€œå¤å¤â€ã€â€œç”µå½±â€ç­‰æ»¤é•œé¢„è®¾ã€‚

#### 1.4 è¾…åŠ©å·¥å…·ä¸äº¤äº’ (Tools & Interaction)

- **å¿«æ·é”®ç³»ç»Ÿ (Shortcuts)**:
  - [x] **å¯è§†åŒ–é¢æ¿**: å®ç° Keycap é£æ ¼çš„ä¾§è¾¹æŠ½å±‰é€ŸæŸ¥è¡¨ (`ShortcutsPanel`)ã€‚
  - [x] **é€šç”¨æ“ä½œ**: è¦†ç›–å¤åˆ¶ç²˜è´´ã€å›¾å±‚ç§»åŠ¨ã€é”å®šç­‰ã€‚
- **æµ‹é‡å·¥å…· (Measure)**:
  - [x] **ç²¾å‡†è·¯ç”±**: ç‚¹å‡»æ ‡å°ºç»„ä»¶è‡ªåŠ¨è·³è½¬è‡³ `Adjust -> Ruler` é¢æ¿ã€‚
  - [x] **äº¤äº’ç»˜åˆ¶**: æ”¯æŒæ‹–æ‹½åˆ›å»ºæµ‹é‡çº¿ï¼Œè‡ªåŠ¨è®¡ç®—é•¿åº¦ã€‚
- **äº¤äº’ä¼˜åŒ– (Interaction Polish)**:
  - [x] **å³é”®èœå•**: ä¿®å¤ç²˜è´´åæ ‡åç§»ï¼Œå®ç°åŸºäºé¼ æ ‡ä½ç½®çš„å·¦ä¸Šè§’å¯¹é½ã€‚
  - [x] **æ‚¬æµ®èœå•**: å®ç°äº‹ä»¶éš”ç¦»ï¼Œé˜²æ­¢åœ¨æ‚¬æµ®æ¡ä¸Šæ“ä½œæ—¶è¯¯è§¦åº•å±‚ Canvasã€‚
  - [x] **å‰ªè´´æ¿**: é‡æ„ä¸ºå•ä¾‹æ¨¡å¼ (`clipboardState`)ã€‚

#### 1.5 å…¨å±€å¯¼èˆªç³»ç»Ÿ (Global Navigation System) `Major Upgrade`

- **å¯¹è±¡é©±åŠ¨è·¯ç”± (Object-Driven Routing)**:
  - [x] **æ™ºèƒ½åˆ†å‘**: å®ç°äº† `useEditorState` ä¸­çš„ `routeToObject`ï¼Œæ ¹æ® Canvas é€‰ä¸­å¯¹è±¡è‡ªåŠ¨åˆ‡æ¢ UIã€‚
  - [x] **äºŒçº§å¯¼èˆª (Level 2 Support)**: æ”¯æŒç²¾ç¡®è·³è½¬è‡³ç‰¹å®šæŠ˜å é¢æ¿ (å¦‚ `Tool: Adjust` + `Tab: Ruler`)ã€‚
  - [x] **å…ƒæ•°æ®æ³¨å…¥ (Metadata Injection)**: æ”¯æŒé€šè¿‡ `customTab` / `customTool` å±æ€§è¦†ç›–é»˜è®¤è·¯ç”±è¡Œä¸ºã€‚
  - [x] **Fix Ruler Navigation**: ä¿®å¤ç‚¹å‡»æ ‡å°ºç»„ä»¶è‡ªåŠ¨è§¦å‘ä¾§è¾¹æ è·³è½¬çš„ Bugã€‚
  - [x] **Fix Crop/Rotate Navigation**: ä¿®å¤ç‚¹å‡»è£å‰ª/æ—‹è½¬æ¨¡å—è·³è½¬åˆ°è¾¹æ¡†æ¨¡å—çš„ Bugã€‚
- **è§†å›¾è§£è€¦**:
  - [x] **çŠ¶æ€ç›‘å¬**: ä¾§è¾¹æ ç»„ä»¶ (`index.vue`) é€šè¿‡ `watch` ç›‘å¬å…¨å±€è·¯ç”±çŠ¶æ€è‡ªåŠ¨å±•å¼€å¯¹åº”æ¨¡å—ã€‚
  - [x] **å»é™¤æ®‹å½±**: ç§»é™¤äº†æœªé€‰ä¸­æ—¶çš„ Sidebar Disabled çŠ¶æ€ï¼Œä¿æŒç•Œé¢å§‹ç»ˆå¯ç”¨ã€‚

---

## 2. ç³»ç»Ÿæ¶æ„å¤‡å¿˜ (Architecture Memo)

### 2.1 é«˜æ¸…ç¦»å±æ¸²æŸ“ç®¡çº¿ (High-Res Offscreen Pipeline)

> **Pattern**: `src/composables/useOffscreenHelper.js`

- **é€»è¾‘**: è·å–åŸå›¾åŸå§‹åˆ†è¾¨ç‡ -> åˆ›å»ºä¸´æ—¶ StaticCanvas -> æ˜ å°„æ•ˆæœ -> å¯¼å‡ºé«˜æ¸…å›¾ã€‚

### 2.2 ç‰©ç†çº¦æŸç³»ç»Ÿ (Constraint System)

> **Pattern**: `src/composables/useConstraint.js`

- **é€»è¾‘**: è®¡ç®—å¯¹è±¡ç›¸å¯¹äºå®¹å™¨çš„æº¢å‡ºå€¼ï¼ŒResizing æ—¶å®æ—¶ä¿®æ­£ï¼ŒPuzzle æ‹–æ‹½æ—¶è§¦å‘å›å¼¹ã€‚

### 2.3 çŠ¶æ€ä¸å¿«æ·é”® (State & Shortcuts)

- **State**: ä½¿ç”¨ `useEditorState.js` (Reactive å•ä¾‹) ç®¡ç†å…¨å±€çŠ¶æ€ã€‚
- **Shortcuts**: é‡‡ç”¨é…ç½®åŒ–ç­–ç•¥ï¼Œ`ShortcutsPanel` UI ä¸ `useKeyboardShortcuts` é€»è¾‘å…±ç”¨åŒä¸€ä»½é…ç½®æºã€‚

### 2.4 å¯¹è±¡é©±åŠ¨è·¯ç”±æ¶æ„ (Object-Driven Routing Architecture) `NEW`

> **Core Philosophy**: Canvas æ˜¯è·¯ç”±è§¦å‘å™¨ï¼ŒState æ˜¯æ§åˆ¶å™¨ï¼ŒSidebar æ˜¯è§†å›¾ã€‚

- **é…ç½®å±‚ (Configuration)**:
  - `OBJECT_TO_TOOL_MAP` (in `useEditorState.js`): å®šä¹‰ç±»å‹åˆ°é¢æ¿çš„æ˜ å°„ (e.g., `'i-text' -> { tool: 'text', tab: 'style' }`)ã€‚
- **æ„ŸçŸ¥å±‚ (Sensor)**:
  - `useCanvas.js`: ç›‘å¬ `mouse:up`, `selection:created`, `selection:updated`ã€‚
  - è¿‡æ»¤å¤šé€‰ (`activeSelection`) å’Œç‰¹æ®Šå¯¹è±¡ï¼Œæå– `customTab` ä¿¡æ ‡ã€‚
- **æ³¨å…¥å±‚ (Injection)**:
  - åœ¨åˆ›å»ºç‰¹æ®Šå¯¹è±¡ (å¦‚æ ‡å°ºã€ç´ æ) æ—¶ï¼Œæ³¨å…¥ `{ customTab: 'ruler' }` å±æ€§å®ç°ç²¾ç¡®è·³è½¬ã€‚
- **è§†å›¾å±‚ (View)**:
  - å·¦ä¾§èœå•é«˜äº® `state.activeTool`ã€‚
  - äºŒçº§é¢æ¿ (å¦‚ AdjustPanel) ç›‘å¬ `state.activeTab` å¹¶è‡ªåŠ¨å±•å¼€å¯¹åº”æ¨¡å—ã€‚

### 2.4 å¼ºåˆ¶ç±»å‹å®‰å…¨åŸåˆ™ (Type Safety)

- **é—®é¢˜è®°å½•**ï¼šUI è¾“å…¥æ§ä»¶ï¼ˆSlider/Inputï¼‰ç»‘å®šçš„å“åº”å¼æ•°æ®ï¼Œåœ¨ç”¨æˆ·äº¤äº’åä¼šè‡ªåŠ¨é€€åŒ–ä¸º String ç±»å‹ï¼Œå¯¼è‡´æ•°å­¦è®¡ç®—ï¼ˆå°¤å…¶æ˜¯ + è¿ç®—ï¼‰å‡ºé”™ã€‚

- **å¼ºåˆ¶è§„èŒƒ**ï¼š

    1. åœ¨ Vue æ¨¡æ¿ä¸­ï¼Œæ‰€æœ‰æ•°å€¼å‹è¾“å…¥å¿…é¡»ä¸¥æ ¼ä½¿ç”¨ v-model.number ä¿®é¥°ç¬¦ã€‚

    2. åœ¨ JS é€»è¾‘å¤„ç†è®¡ç®—å‰ï¼Œå¿…é¡»å¯¹æ‰€æœ‰æ¥è‡ª UI çš„å˜é‡è¿›è¡Œé˜²å¾¡æ€§è½¬æ¢ï¼Œä¾‹å¦‚ Number(value) æˆ– parseFloat(value)ã€‚

    3. ç¦æ­¢ç›´æ¥ä¿¡ä»» UI ç»‘å®šçš„å˜é‡ç±»å‹ã€‚

---

## 3. å¾…åŠäº‹é¡¹ (Backlog & Roadmap)

### ğŸ“… è¿‘æœŸè®¡åˆ’ (Next Sprint)

### ğŸ› å·²çŸ¥ä¼˜åŒ–ç‚¹ (Refactoring)
